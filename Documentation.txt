# PRISM - Post-Production Management System
## Comprehensive Project Documentation & Technical Specification

### 1. Introduction
PRISM (Post-Production Management System) is an enterprise-grade studio management solution specifically engineered for post-production houses. It streamlines complex scheduling, billing, and resource management tasks, providing a unified interface for studio administrators, accountants, and operations teams. The system is built with a focus on high-density information display, real-time conflict detection, and robust role-based access control.

---

### 2. Full Installation & Server Setup Guide

#### 2.1 Server Requirements
- **Operating System**: Linux (Ubuntu 22.04+ recommended), macOS, or Windows (via WSL2).
- **Runtime**: Node.js v20.x or higher.
- **Database**: PostgreSQL v14.x or higher.
- **Memory**: Minimum 2GB RAM.
- **Storage**: SSD recommended for database performance.

#### 2.2 PostgreSQL Database Setup
1. **Install PostgreSQL**:
   ```bash
   # On Ubuntu/Debian
   sudo apt update
   sudo apt install postgresql postgresql-contrib
   ```
2. **Create Database User & Schema**:
   Access the PostgreSQL prompt:
   ```bash
   sudo -u postgres psql
   ```
   Execute the following SQL commands to create the environment:
   ```sql
   CREATE DATABASE prism_db;
   CREATE USER prism_admin WITH PASSWORD 'secure_password_here';
   GRANT ALL PRIVILEGES ON DATABASE prism_db TO prism_admin;
   \c prism_db
   GRANT ALL ON SCHEMA public TO prism_admin;
   ```

#### 2.3 Application Deployment
1. **Clone & Install**:
   ```bash
   git clone <repository-url> prism
   cd prism
   npm install
   ```
2. **Environment Configuration**:
   Create a `.env` file in the root directory:
   ```env
   DATABASE_URL=postgres://prism_admin:secure_password_here@localhost:5432/prism_db
   NODE_ENV=production
   SESSION_SECRET=a_very_long_random_string_here
   ```
3. **Initialize Schema**:
   PRISM uses Drizzle ORM for schema management. Sync the database structure:
   ```bash
   npm run db:push
   ```
4. **Build Production Assets**:
   Compile the React frontend and TypeScript backend:
   ```bash
   npm run build
   ```
5. **Process Management (PM2)**:
   It is recommended to use PM2 to keep the server running:
   ```bash
   npm install -g pm2
   pm2 start dist/index.cjs --name prism-app
   pm2 save
   ```

---

### 3. Detailed Project Features

#### 3.1 Operations Module
The core engine of the studio, handling transactional data.

- **Unified Booking Calendar**: 
  - **Daily View**: Hour-by-hour breakdown of room usage.
  - **Monthly View**: High-level availability overview.
  - **Drag-and-Drop**: Reschedule events by moving them across time slots.
  - **Quick Edit**: Instant modification of booking statuses (Planning, Tentative, Confirmed, Cancelled).
- **Conflict Detection Engine**: 
  - Validates room availability before saving.
  - Validates editor availability across all rooms.
  - Checks against "Ignore Conflict" flags for special cases.
- **Leave Management**: 
  - Interfaces for editors to log sick leave or vacation.
  - Integrated with the booking engine to provide visual warnings if a leave overlaps with a session.
- **Chalan (Billing) Lifecycle**:
  - **Automated Generation**: Pulls data from `bookings`, `rooms`, and `editors` to generate a draft chalan.
  - **Revision Tracking**: Every edit to a chalan creates a new `chalan_revision` entry, allowing users to see "Who changed What and When".
  - **Cancellation Logic**: Requires a mandatory reason; once cancelled, the chalan is archived but remains searchable for audit.

#### 3.2 Masters Module (Core Reference Data)
- **Customer Master**: 
  - Manage client organizations.
  - Store billing preferences, GST numbers, and addresses.
  - **Contact Management**: Multiple contacts per customer (e.g., Producer, Director, Production Manager) with designation tracking.
- **Project Master**: 
  - Project types: Movie, Serial, Web Series, Ad, Teaser, Trilogy.
  - Status tracking (Active/Inactive).
  - Linked directly to Customers for billing accuracy.
- **Room Master**: 
  - Room types: Sound, Music, VFX, Client Office, Editing, Dubbing, Mixing.
  - Capacity settings and conflict rule configuration.
- **Editor Master**: 
  - Categorization: Video, Audio, VFX, Colorist, DI.
  - Join/Leave date tracking.
  - Performance and utilization history.

#### 3.3 Reports & Analytics
- **Conflict Reports**: Identify and resolve overlapping schedules before they cause production delays.
- **Booking Reports**: Export custom data ranges to Excel/CSV for external analysis.
- **Utilization Reports**: Statistical breakdown of room and editor billable vs. non-billable hours.
- **Chalan Reports**: Financial overview of generated, paid, and pending chalans.

#### 3.4 Utility & Administration
- **Granular User Rights**: 
  - Administrators can define custom access levels. 
  - Permissions are split into: **View, Create, Edit, Delete**.
  - Section-level control: e.g., a user can edit Bookings but only view Chalans.
- **Audit Logging**: 
  - `booking_logs` capture every state change.
  - `user_module_access` ensures strictly enforced RBAC.

---

### 4. Technical Architecture & Code Structure

#### 4.1 Technology Stack
- **Frontend**: 
  - **React 18**: Component-based UI.
  - **Tailwind CSS**: Utility-first styling with custom "elevate" interaction classes.
  - **Shadcn UI**: Accessible primitive components.
  - **TanStack Query (v5)**: Efficient server-state management and caching.
  - **Wouter**: Lightweight client-side routing.
- **Backend**: 
  - **Node.js & Express.js**: High-performance API layer.
  - **Passport.js**: Authentication strategies.
  - **Express Session**: Secure session persistence.
- **Database Layer**: 
  - **Drizzle ORM**: Type-safe SQL generation and schema management.
  - **PostgreSQL**: Reliable relational data storage.
- **Validation**: 
  - **Zod**: Schema validation for both frontend forms and backend API requests.

#### 4.2 Directory Organization
- **`/client`**: Frontend application source.
  - **`/src/pages`**: 
    - `booking.tsx`: Main calendar and operation hub.
    - `chalan/index.tsx`: Billing list and management.
    - `masters/`: Master data management pages.
    - `utility/`: Administrative tools.
  - **`/src/components`**: 
    - `ui/`: Shared Shadcn components.
    - `data-table.tsx`: Generic, sortable, and exportable data grid.
    - `booking-form.tsx`: Complex multi-step scheduling form.
  - **`/src/lib`**: 
    - `queryClient.ts`: TanStack Query configuration.
    - `permissions.ts`: Client-side RBAC enforcement.
- **`/server`**: Backend application source.
  - **`routes.ts`**: Central API router (~1200+ lines) containing all business logic endpoints.
  - **`storage.ts`**: Interface-driven data access layer (`IStorage`) implementing all PostgreSQL queries.
  - **`db.ts`**: Connection pooling and ORM initialization.
  - **`index.ts`**: Server entry point and middleware configuration.
- **`/shared`**: Code shared between frontend and backend.
  - **`schema.ts`**: The single source of truth for the database schema, table definitions, and relationships.

---

### 5. API Reference (Detailed)

#### 5.1 Authentication (`/api/auth`)
- `POST /login`: Validates username, PIN, and company ID. Sets secure session.
- `POST /logout`: Destroys server session and clears client cookies.
- `GET /session`: Returns currently authenticated user details and their permissions.

#### 5.2 Operations (`/api/bookings`, `/api/chalans`)
- `GET /bookings`: Retrieves scheduled events with support for room, date, and status filters.
- `POST /bookings`: Creates new events. Supports "Repeat Booking" logic for multi-day sessions.
- `POST /bookings/check-conflicts`: Real-time validation endpoint used during scheduling.
- `POST /chalans`: Finalizes billing documents. Generates unique chalan numbers.
- `GET /chalans/:id/revisions`: Fetches the version history of a specific billing document.

#### 5.3 Masters (`/api/customers`, `/api/projects`, `/api/rooms`, `/api/editors`)
- Standard CRUD (Create, Read, Update, Delete) endpoints for all reference data.
- Permission-guarded to prevent unauthorized data modification.

#### 5.4 Admin & Utility (`/api/users`, `/api/reports`)
- `GET /users`: List all system users with their roles (Admin, Account, GST, Non-GST, Custom).
- `POST /users/:id/access`: Updates granular permissions for "Custom" role users.
- `GET /reports/conflicts`: Generates a list of all current scheduling overlaps.

---

### 6. Database Schema Deep-Dive

#### 6.1 Entity Definitions
- **`users`**: Contains `id`, `username`, `security_pin`, `role`, `company_id`, and `is_active`.
- **`bookings`**: Stores `room_id`, `customer_id`, `project_id`, `booking_date`, `from_time`, `to_time`, and `status`.
- **`chalans`**: Links to `customer_id`, `project_id`, and `booking_id`. Contains financial data and `is_cancelled` flags.
- **`user_module_access`**: Bridges users to permissions. Stores booleans for View/Create/Edit/Delete across various system modules.

#### 6.2 Relational Integrity
- **Cascading Deletes**: Controlled at the application level in `storage.ts` to prevent accidental loss of financial or audit data.
- **Foreign Keys**: Enforced at the database level for all relationships (e.g., a project cannot exist without a valid customer).

---

### 7. Security Architecture
- **Environment Isolation**: Secrets like `DATABASE_URL` and `SESSION_SECRET` are stored in environment variables.
- **Data Sanitization**: Backend routes manually strip sensitive fields (like PINs) before sending JSON responses to the client.
- **RBAC Enforcement**: A dual-layer permission check system:
  1. **Frontend**: UI elements are hidden based on user role/permissions.
  2. **Backend**: Middleware (`requirePermission`) validates every API request against the user's rights stored in the database.
- **CSRF Protection**: Standard session-based security and CORS configuration.

---

### 8. Frontend Design System
PRISM uses a highly opinionated design system based on:
- **Consistency**: 8px (0.5rem) grid system for spacing.
- **Interactions**: Custom `hover-elevate` and `active-elevate-2` classes for tactile feedback.
- **Typography**: Clear hierarchy using standard font sizes and secondary/tertiary colors for metadata.
- **Forms**: Built using `react-hook-form` and `zodResolver` for instant user feedback and validation.

---

### 9. Development Workflow
- **Database Migrations**: `npm run db:push` to sync local schema changes with PostgreSQL.
- **Vite Dev Server**: `npm run dev` for hot-module replacement and rapid frontend iteration.
- **Production Readiness**: Always run `npm run build` before deployment to ensure all assets are minified and optimized.
