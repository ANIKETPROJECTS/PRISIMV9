# 7. PRISM: Technical Specification & API Reference
## Developer & Integration Manual

### 7.1 The PRISM Developer Core
This document serves as the technical reference for developers maintaining or extending the PRISM system. It details the internal data structures, API contracts, and the "Middleware Pipeline" that powers the application.

### 7.2 Database Schema Reference (The Source of Truth)
The schema is implemented using Drizzle ORM and is strictly typed.

#### A. Core Relational Tables
- **`users`**: The authentication anchor. Stores roles and hashed PINs.
- **`bookings`**: The central transactional table. Links rooms, editors, and projects.
- **`chalans` & `chalan_items`**: The financial documents. Uses decimal/numeric types for precision billing.
- **`user_module_access`**: The permission mapping table for Custom RBAC.

#### B. Native PostgreSQL Enums
To ensure data consistency at the database level, PRISM uses native enums:
- `userRoleEnum`: ["admin", "gst", "non_gst", "account", "custom"]
- `projectTypeEnum`: ["movie", "serial", "web_series", "ad", "teaser", "trilogy"]
- `bookingStatusEnum`: ["planning", "tentative", "confirmed", "cancelled"]

### 7.3 API Endpoint Contract
All API communication is handled via JSON over REST.

#### A. Authentication Endpoints
- `POST /api/auth/login`: Handled by `passport-local`. Sets the session cookie.
- `GET /api/auth/session`: Returns the current user's profile and permissions.

#### B. Operational Endpoints
- `GET /api/bookings`: Supports filters like `from`, `to`, `roomId`, and `status`.
- `POST /api/bookings/check-conflicts`: A pre-flight validation endpoint used by the UI during scheduling.
- `PATCH /api/bookings/:id`: Handles status transitions and actual time entry.

#### C. Master Data Endpoints
- `GET /api/customers`, `GET /api/projects`, `GET /api/rooms`, `GET /api/editors`: All support standard CRUD operations with role-based restrictions.

### 7.4 The Backend Pipeline
Every API request follows a deterministic 5-step lifecycle:

1.  **Session Extraction**: The `authMiddleware` extracts the user ID from the encrypted cookie.
2.  **User Verification**: The system checks if the user is still active in the database.
3.  **Permission Guard**: The `requirePermission` middleware checks the user's rights for the target module.
4.  **Schema Validation**: The request body is parsed through a **Zod** schema. If validation fails, a `400 Bad Request` is returned with detailed field errors.
5.  **Storage Execution**: The business logic is executed in `server/storage.ts`, interacting with the database through Drizzle.

### 7.5 State Synchronization (Frontend)
The frontend uses **TanStack Query** to manage server state.
- **Query Keys**: Standardized keys (e.g., `["/api/bookings"]`) are used for automatic cache invalidation.
- **Mutations**: Every "POST/PATCH" request automatically invalidates relevant query keys, ensuring the UI (especially the calendar) is always accurate across multiple open browsers.

---
*End of Document 7 - Technical Specification*
