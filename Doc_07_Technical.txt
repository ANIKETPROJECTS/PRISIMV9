# 7. PRISM: Technical Specification & API Reference
## Developer, Integration & API Reference Manual

### 7.1 The PRISM Developer Core: Engineering Excellence
This document serves as the authoritative technical reference for senior engineers, DevOps professionals, and developers maintaining or extending the PRISM system. It details the internal data structures, API contracts, and the sophisticated "Middleware Pipeline" that ensures the application's stability and speed.

### 7.2 Database Schema Reference: The Relational Source of Truth
PRISM's data layer is implemented using **Drizzle ORM** over PostgreSQL. The schema is strictly typed, ensuring that "Runtime Errors" related to data structure are virtually non-existent.

#### 7.2.1 Core Relational Table Definitions
- **`users`**: The security anchor. Stores hashed credentials, roles, and status flags.
- **`bookings`**: The central transactional hub. A complex table linking Room IDs, Editor IDs, and Project IDs with millisecond-accurate timestamps.
- **`chalans` & `chalan_items`**: The financial core. Uses `numeric` and `decimal` database types to ensure zero rounding errors in billing calculations.
- **`user_module_access`**: The bridge table for the RBAC system, mapping user IDs to specific module permissions.

#### 7.2.2 Native Database Consistency (Enums)
PRISM leverages PostgreSQL's native `ENUM` types to enforce data quality at the lowest level:
- `userRoleEnum`: Hard-coded roles: ["admin", "gst", "non_gst", "account", "custom"].
- `projectTypeEnum`: Industry types: ["movie", "serial", "web_series", "ad", "teaser", "trilogy"].
- `bookingStatusEnum`: Workflow states: ["planning", "tentative", "confirmed", "cancelled"].

### 7.3 API Endpoint Architecture and Contracts
The PRISM API is a standardized RESTful interface communicating entirely via JSON.

#### 7.3.1 Authentication & Session Endpoints
- `POST /api/auth/login`: The entry point. Validates credentials and sets the `connect.sid` cookie.
- `GET /api/auth/session`: The "Who Am I" endpoint. Returns the user's role, permissions, and company context.

#### 7.3.2 Operational Transactional Endpoints
- `GET /api/bookings`: The calendar data source. Supports complex query params: `from`, `to`, `roomId`, `customerId`, and `status`.
- `POST /api/bookings/check-conflicts`: A high-performance validation endpoint used for real-time UI feedback during scheduling.
- `PATCH /api/bookings/:id`: Handles state transitions and the ingestion of "Actual Session Times."

#### 7.3.3 Master Data CRUD Endpoints
- `GET /api/customers`, `GET /api/projects`, `GET /api/rooms`, `GET /api/editors`: These follow a standardized CRUD pattern with built-in permission guards.

### 7.4 The Backend Execution Pipeline
Every request to the PRISM API follows a deterministic, 5-step lifecycle:

1.  **Session Extraction**: The `authMiddleware` decodes the encrypted session cookie and extracts the user context.
2.  **Identity Verification**: The system verifies the user exists and is still marked as `isActive`.
3.  **Permission Authorization**: The `requirePermission` middleware checks the User's RBAC matrix against the target module and requested action.
4.  **Schema Validation (Zod)**: The request payload is parsed against a strict Zod schema. Invalid requests are rejected with a detailed `400 Bad Request` and field-level error messages.
5.  **Storage Isolation**: The logic is executed in the `storage.ts` layer, which abstracts the database complexity away from the route handlers.

### 7.5 State Synchronization and Cache Logic
The frontend leverages **TanStack Query** for industry-leading state management.
- **Query Keys**: Standardized array-based keys (e.g., `["/api/bookings", dateRange]`) ensure that the calendar only fetches what it needs.
- **Automatic Invalidation**: Every write operation (POST/PATCH/DELETE) triggers an automatic background refresh of the relevant query keys, ensuring that if a manager in Room A cancels a booking, the manager in Room B sees the change instantly.

### 7.6 Advanced Technical Infrastructure
- **Relational Integrity via Drizzle**: How the system handles complex JOINs across 5+ tables while maintaining sub-100ms response times.
- **Error Propagation Pattern**: Standardized JSON error response format: `{ "message": "Descriptive error", "errors": [...] }`.
- **CORS and CSRF Protection**: Strict origin policies and signed cookies ensure the API is only accessible to authorized clients.

---
*End of Document 7 - Technical Specification*
